{"version":3,"names":["currentUserId","common_vendor","ref","Number","index","getStorageSync","currentUserAvatar","rawAvatar","value","startsWith","concat","location","origin","targetUserId","messages","inputValue","formatTime","time","dayjs","format","loadMessages","_ref","_asyncToGenerator2","_regeneratorRuntime2","mark","_callee","res","wrap","_callee$","_context","prev","next","api_http","http","get","sent","__f__","data","map","msg","_objectSpread2","createdAt","senderAvatar","t0","showToast","title","icon","stop","apply","arguments","sendMessage","_ref2","_callee2","_callee2$","_context2","trim","abrupt","post","receiverId","content","push","id","senderId","Date","toISOString","nextTick$1","pageScrollTo","scrollTop","duration","markAsRead","_ref3","_callee3","_callee3$","_context3","put","onLoad","options","userId","wx","createPage","_sfc_main"],"sources":["chat.vue","cGFnZXMvY2hhdC9jaGF0LnZ1ZQ"],"sourcesContent":["<!-- pages/chat/chat.vue -->\n<template>\n  <view class=\"container\">\n    <!-- 聊天内容区域 -->\n    <scroll-view \n      class=\"chat-scroll\"\n      scroll-y \n      :scroll-into-view=\"'lastMsg'\"\n      :scroll-with-animation=\"true\"\n    >\n      <view \n        v-for=\"(msg, index) in messages\" \n        :key=\"msg.id\"\n        :id=\"'msg' + index\"\n        class=\"message-wrap\"\n        :class=\"{ 'self-message': msg.senderId === currentUserId }\"\n      >\n        <!-- 对方头像 -->\n        <image \r\n          v-if=\"msg.senderId !== currentUserId\"\r\n          :src=\"msg.senderAvatar || '/static/default-avatar.png'\"\r\n          class=\"avatar left\"\r\n        />\n        \n        <!-- 消息气泡 -->\n        <view class=\"bubble\" :class=\"{ 'self-bubble': msg.senderId === currentUserId }\">\n          <text class=\"content\">{{ msg.content }}</text>\n          <text class=\"time\">{{ formatTime(msg.createdAt) }}</text>\n        </view>\n\n        <!-- 自己头像 -->\n        <image \r\n          v-if=\"msg.senderId === currentUserId\"\r\n          :src=\"currentUserAvatar\"\r\n          class=\"avatar right\"\r\n        />\n      </view>\n      <view id=\"lastMsg\"></view>\n    </scroll-view>\n\n    <!-- 输入区域 -->\n    <view class=\"input-area\">\n      <input\n        v-model=\"inputValue\"\n        class=\"input\"\n        placeholder=\"输入消息\"\n        @confirm=\"sendMessage\"\n      />\n      <button class=\"send-btn\" @click=\"sendMessage\">发送</button>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted, nextTick } from 'vue'\nimport { onLoad } from '@dcloudio/uni-app'\nimport dayjs from 'dayjs'\nimport { http } from '@/api/http' // 关键修改1：引入封装好的http模块\n\n// 数据部分\nconst currentUserId = ref(Number(uni.getStorageSync('userId')));\r\nconst currentUserAvatar = ref('')\nconst rawAvatar = uni.getStorageSync('avatar')\ncurrentUserAvatar.value = rawAvatar \n  ? (\n    rawAvatar.startsWith('http://') || \n    rawAvatar.startsWith('https://') \n      ? rawAvatar \n      : `${location.origin}${rawAvatar.startsWith('/') ? '' : '/'}${rawAvatar}`\n  )\n  : '/static/default-avatar.png'\n\nconst targetUserId = ref(null)\nconst messages = ref([])\nconst inputValue = ref('')\n\n// 时间格式化\nconst formatTime = (time) => {\n  return dayjs(time).format('HH:mm')\n}\n\n// 加载聊天记录（已修改）\nconst loadMessages = async () => {\n  try {\n    // 关键修改2：使用封装后的http方法\n    const res = await http.get(`/chat/${targetUserId.value}`)\n    console.log('后端返回数据:', res.data);\n    messages.value = res.data.map(msg => ({\n      ...msg,\n      createdAt: msg.createdAt,\n      senderAvatar: msg.senderAvatar || '/static/default-avatar.png'\n    }))\n  } catch (e) {\n    uni.showToast({ title: '加载消息失败', icon: 'none' })\n  }\n}\n\n// 发送消息（已修改）\nconst sendMessage = async () => {\n  if (!inputValue.value.trim()) return\n  \n  try {\n    // 关键修改3：使用封装后的post方法\n    const res = await http.post('/chat', {\n      receiverId: targetUserId.value,\n      content: inputValue.value\n    })\n    \n    // 调整数据结构（根据实际接口返回结构）\n    messages.value.push({\n      id: res.id, // 直接使用返回的id\n      senderId: currentUserId.value,\n      content: inputValue.value,\n      createdAt: new Date().toISOString(),\n      senderAvatar: currentUserAvatar.value\n    })\n    \n    inputValue.value = ''\n    \n    // 滚动到底部\n    await nextTick()\n    uni.pageScrollTo({\n      scrollTop: 99999,\n      duration: 300\n    })\n  } catch (e) {\n    uni.showToast({ title: '发送失败', icon: 'none' })\n  }\n}\n\n// 标记已读（已修改）\nconst markAsRead = async () => {\n  try {\n    // 关键修改4：使用封装后的put方法\n    await http.put(`/chat/${targetUserId.value}/mark-as-read`)\n  } catch (e) {\n    console.error('标记已读失败', e)\n  }\n}\n\n// 生命周期\nonLoad((options) => {\r\n  console.log('当前用户头像路径:', currentUserAvatar.value)\n  targetUserId.value = options.userId\n  loadMessages()\n  markAsRead()\n})\n</script>\n\n<style lang=\"scss\">\n/* 样式部分保持不变 */\n.container {\n  height: 100vh;\n  display: flex;\n  flex-direction: column;\n  background: #f5f5f5;\n}\n\n.chat-scroll {\n  flex: 1;\n  padding: 20rpx;\n  overflow-anchor: auto;\n}\n\n.message-wrap {\n  display: flex;\n  margin-bottom: 40rpx;\n  \n  &.self-message {\n    flex-direction: row-reverse;\r\n\t\r\n\t.avatar.right {\r\n\t    margin-left: 0 !important;  // 清除原有左边距\r\n\t    margin-right: 20rpx;\r\n\t}\n  }\n}\n\n.avatar {\n  width: 80rpx;\n  height: 80rpx;\n  border-radius: 8rpx;\n  flex-shrink: 0;\n  &.left {\n    margin-right: 20rpx;\n  }\n  \n  &.right {\n    margin-left: 20rpx;\n  }\n}\n\n.bubble {\n  max-width: 500rpx;\n  min-width: 120rpx;\n  padding: 20rpx;\n  border-radius: 12rpx;\n  position: relative;\n  \n  .content {\n    font-size: 28rpx;\n    line-height: 1.5;\n  }\n  \n  .time {\n    position: absolute;\n    right: 20rpx;\n    bottom: 10rpx;\n    font-size: 20rpx;\n    color: #999;\n  }\n  \n  &:not(.self-bubble) {\n    background: #fff;\n    margin-left: 20rpx;\n    \n    .time {\n      color: #666;\n    }\n  }\n  \n  &.self-bubble {\n    background: #007AFF;\n    color: white;\n    margin-right: 20rpx;\n    \n    .time {\n      color: rgba(255,255,255,0.7);\n    }\n  }\n}\n\n.input-area {\n  display: flex;\n  align-items: center;\n  padding: 20rpx;\n  background: #fff;\n  border-top: 1rpx solid #eee;\n  \n  .input {\n    flex: 1;\n    height: 70rpx;\n    padding: 0 20rpx;\n    border: 1rpx solid #ddd;\n    border-radius: 8rpx;\n    margin-right: 20rpx;\n  }\n  \n  .send-btn {\n    width: 140rpx;\n    height: 70rpx;\n    line-height: 70rpx;\n    background: #007AFF;\n    color: white;\n    border-radius: 8rpx;\n    font-size: 28rpx;\n    \n    &:active {\n      opacity: 0.8;\n    }\n  }\n}\n</style>","import MiniProgramPage from 'C:/Users/SZQ/Desktop/jinleyou_uniapp/pages/chat/chat.vue'\nwx.createPage(MiniProgramPage)"],"mappings":"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","ignoreList":[]}