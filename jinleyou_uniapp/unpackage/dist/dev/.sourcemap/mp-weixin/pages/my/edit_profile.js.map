{"version":3,"file":"edit_profile.js","sources":["pages/my/edit_profile.vue","../../Programming/HBuilderX.4.57.2025032507/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbXkvZWRpdF9wcm9maWxlLnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"edit-container\">\n    <!-- \n    <uni-nav-bar \n      title=\"编辑资料\" \n      left-icon=\"back\" \n      @clickLeft=\"goBack\"\n      :border=\"false\"\n      fixed\n    />\n    -->\n    <!-- 表单容器 -->\n    <scroll-view scroll-y class=\"form-container\">\n      <!-- 头像上传 -->\n      <view class=\"form-item\">\n        <text class=\"label\">头像</text>\n        <view class=\"avatar-upload\" @click=\"changeAvatar\">\n          <image class=\"avatar\" :src=\"form.avatar || '/static/default-avatar.png'\" mode=\"aspectFill\" />\n          <uni-icons type=\"camera-filled\" size=\"24\" color=\"#fff\" class=\"camera-icon\" />\n          <view v-if=\"uploading\" class=\"upload-progress\">\n            <text>{{ uploadProgress }}%</text>\n          </view>\n        </view>\n      </view>\n      \n      <!-- 昵称 -->\n      <view class=\"form-item\">\n        <text class=\"label\">昵称</text>\n        <input \n          v-model=\"form.nickname\" \n          placeholder=\"请输入2-12位昵称\" \n          maxlength=\"12\"\n          @blur=\"validateNickname\"\n        />\n        <text v-if=\"errors.nickname\" class=\"error-text\">{{ errors.nickname }}</text>\n      </view>\n      \n      <!-- 性别 -->\n      <view class=\"form-item\">\n        <text class=\"label\">性别</text>\n        <picker \n          mode=\"selector\" \n          :range=\"genderOptions\" \n          range-key=\"label\"\n          @change=\"onGenderChange\"\n        >\n          <view class=\"picker\">\n            {{ genderOptions[form.gender].label || '请选择性别' }}\n          </view>\n        </picker>\n      </view>\n      \n      <!-- 个人简介 -->\n      <view class=\"form-item\">\n        <text class=\"label\">个人简介</text>\n        <textarea \n          v-model=\"form.bio\" \n          placeholder=\"介绍一下自己吧~\"\n          maxlength=\"100\"\n          auto-height\n        />\n        <text class=\"word-count\">{{ form.bio.length }}/100</text>\n      </view>\n      \n      <!-- 保存按钮 -->\n      <button \n        class=\"save-btn\" \n        :class=\"{ disabled: !formChanged || hasErrors }\"\n        :disabled=\"!formChanged || hasErrors || saving\"\n        @click=\"saveProfile\"\n      >\n        <text v-if=\"!saving\">保存修改</text>\n        <uni-load-more v-else status=\"loading\" :icon-size=\"16\" :content-text=\"loadingText\" />\n      </button>\n    </scroll-view>\n  </view>\n</template>\n\n<script>\nimport { mapMutations, mapState } from 'vuex';\r\nimport { http, ENV_CONFIG } from '@/api/http';\nexport default {\n  data() {\n    return {\n      form: {\n        avatar: '',\n        nickname: '',\n        gender: 0,\n        bio: ''\n      },\n      originalForm: {},\n      errors: {\n        nickname: ''\n      },\n      genderOptions: [\n        { label: '保密', value: 0 },\n        { label: '男', value: 1 },\n        { label: '女', value: 2 }\n      ],\n      uploading: false,\n      uploadProgress: 0,\n      saving: false,\n      loadingText: {\n        contentdown: '保存中',\n        contentrefresh: '保存中',\n        contentnomore: '保存中'\n      }\n    };\n  },\n\tcomputed: {\n\t\t...mapState('user', ['info']), // 映射 user 模块的 info 状态\r\n\t\tuserInfo() {\r\n\t\t\treturn this.info || {}; // 保持模板兼容性\r\n\t\t},\n\t\t// 检查表单是否有变化\n\t\tformChanged() {\n\t\t\treturn JSON.stringify(this.form) !== JSON.stringify(this.originalForm);\n\t\t},\n\t\t// 检查是否有错误\n\t\thasErrors() {\n\t\t\treturn this.errors.nickname !== '';\n\t\t}\n\t},\n\tonLoad() {\n\t\t// 初始化表单数据\n\t\tthis.initFormData();\n\t},\r\n\tonShow() {\r\n\t\tif (!Object.keys(this.userInfo).length) {\r\n\t\t\tthis.getUserInfo(); // 从 my.vue 中提取并复用该方法\r\n\t\t}\r\n\t},\n  methods: {\r\n\t...mapMutations('user', ['SET_INFO']),\n    // 初始化表单数据\n\t\tinitFormData() {\n\t\t\tthis.form = {\n\t\t\t\tavatar: this.userInfo.avatar || '',\n\t\t\t\tnickname: this.userInfo.nickname || '',\n\t\t\t\tgender: this.userInfo.gender ?? 0,\n\t\t\t\tbio: this.userInfo.bio || ''\n\t\t\t};\n\t\t\tthis.originalForm = JSON.parse(JSON.stringify(this.form));\n\t\t},\n    \n    // 更换头像\r\n    async changeAvatar() {\r\n      try {\r\n        const res = await uni.chooseImage({\r\n          count: 1,\r\n          sizeType: ['compressed'],\r\n          sourceType: ['album', 'camera'],\r\n          extension: ['jpg', 'jpeg', 'png', 'gif']\r\n        });\r\n    \r\n        if (res.tempFilePaths && res.tempFilePaths.length) {\r\n          this.uploading = true;\r\n          this.uploadProgress = 0;\r\n          \r\n          try {\r\n            const uploadRes = await uni.uploadFile({\r\n              url: `${ENV_CONFIG[process.env.NODE_ENV]}/api/user/upload`,\r\n              filePath: res.tempFilePaths[0],\r\n              name: 'file',\r\n              header: {\r\n                Authorization: `Bearer ${uni.getStorageSync('token')}`\r\n              }\r\n            });\r\n    \r\n            if (uploadRes.statusCode === 200) {\r\n              const data = JSON.parse(uploadRes.data);\r\n              if (data.code === 200) {\r\n                const baseURL = ENV_CONFIG[process.env.NODE_ENV];\r\n                this.form.avatar = baseURL + data.url;\r\n              } else {\r\n                uni.showToast({ title: data.msg || '上传失败', icon: 'none' });\r\n              }\r\n            }\r\n          } catch (error) {\r\n            console.error('上传失败:', error);\r\n            uni.showToast({ title: '头像上传失败', icon: 'none' });\r\n          } finally {\r\n            this.uploading = false;\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error('选择图片失败:', error);\r\n        this.uploading = false;\r\n      }\r\n    },\n    \n    // 性别选择\n    onGenderChange(e) {\n      this.form.gender = e.detail.value;\n    },\n    \n    // 验证昵称\n    validateNickname() {\n      if (!this.form.nickname) {\n        this.errors.nickname = '昵称不能为空';\n      } else if (this.form.nickname.length < 2) {\n        this.errors.nickname = '昵称太短';\n      } else {\n        this.errors.nickname = '';\n      }\n    },\n    \n    // 保存资料\n    async saveProfile() {\r\n      if (this.saving || !this.formChanged || this.hasErrors) return;\r\n      \r\n      this.saving = true;\r\n      try {\r\n        let updateData = { ...this.form };\r\n        const { code, message } = await http.post('/api/user/update', updateData);\r\n        \r\n        if (code === 200) {\r\n          uni.showToast({ title: '修改成功', icon: 'success' });\r\n          this.SET_INFO(this.form);\r\n          setTimeout(() => uni.navigateBack(), 1500);\r\n        } else {\r\n          uni.showToast({ title: message, icon: 'none' });\r\n        }\r\n      } catch (error) {\r\n        console.error('保存失败:', error);\r\n        uni.showToast({ title: '保存失败，请重试', icon: 'none' });\r\n      } finally {\r\n        this.saving = false;\r\n      }\r\n    },\n    \n    goBack() {\n      if (this.formChanged) {\n        uni.showModal({\n          title: '提示',\n          content: '您有未保存的修改，确定要离开吗？',\n          success: (res) => {\n            if (res.confirm) {\n              uni.navigateBack();\n            }\n          }\n        });\n      } else {\n        uni.navigateBack();\n      }\n    }\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n.edit-container {\n  height: 100vh;\n  display: flex;\n  flex-direction: column;\n  background-color: #f5f5f5;\n  overflow: hidden;\n  \n  .form-container {\n    flex: 1;\n    padding: 30rpx;\n    width: 100%;\n    box-sizing: border-box;\n    \n    .form-item {\n      width: 100%;\n      margin-bottom: 40rpx;\n      background-color: #fff;\n      padding: 30rpx;\n      border-radius: 12rpx;\n      box-shadow: 0 2rpx 6rpx rgba(0, 0, 0, 0.05);\n      box-sizing: border-box;\n\n      .label {\n        display: block;\n        font-size: 28rpx;\n        color: #666;\n        margin-bottom: 20rpx;\n      }\n      \n      input, textarea, .picker {\n        width: 100%;\n        font-size: 28rpx;\n        padding: 10rpx 0;\n        border-bottom: 1rpx solid #eee;\n        box-sizing: border-box;\n      }\n      \n      textarea {\n        min-height: 120rpx;\n        width: 100%;\n      }\n      \n      .error-text {\n        color: #ff5a5f;\n        font-size: 24rpx;\n        margin-top: 10rpx;\n        display: block;\n      }\n      \n      .word-count {\n        color: #999;\n        font-size: 24rpx;\n        text-align: right;\n        display: block;\n        margin-top: 10rpx;\n      }\n      \n      .avatar-upload {\n        position: relative;\n        width: 120rpx;\n        height: 120rpx;\n        border-radius: 50%;\n        overflow: hidden;\n        \n        .avatar {\n          width: 100%;\n          height: 100%;\n        }\n        \n        .camera-icon {\n          position: absolute;\n          right: 0;\n          bottom: 0;\n          background-color: rgba(0, 0, 0, 0.5);\n          padding: 8rpx;\n          border-radius: 50%;\n        }\n        \n        .upload-progress {\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background-color: rgba(0, 0, 0, 0.5);\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          \n          text {\n            color: #fff;\n            font-size: 24rpx;\n          }\n        }\n      }\n    }\n    \n    .save-btn {\n      margin-top: 60rpx;\n      background-color: #2867CE;\n      color: #fff;\n      border: none;\n      height: 80rpx;\n      line-height: 80rpx;\n      font-size: 32rpx;\n      border-radius: 40rpx;\n      width: 100%;\n      \n      &.disabled {\n        background-color: #ccc;\n        opacity: 0.7;\n      }\n    }\n  }\n}\n\n/* 全局滚动容器修正 */\n.uni-scroll-view {\n  width: 100% !important;\n}\n\n.uni-scroll-view-content {\n  min-width: auto !important;\n  max-width: 100% !important;\n}\n\n::-webkit-scrollbar {\n  display: none;\n  width: 0;\n  height: 0;\n  color: transparent;\n}\n</style>","import MiniProgramPage from 'C:/Users/SZQ/Desktop/jinleyou_GitHub/jinleyou_uniapp/pages/my/edit_profile.vue'\nwx.createPage(MiniProgramPage)"],"names":["mapState","mapMutations","uni","ENV_CONFIG","http"],"mappings":"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"}