{"version":3,"file":"my.js","sources":["pages/my/my.vue","../Programming/HBuilderX.4.57.2025032507/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbXkvbXkudnVl"],"sourcesContent":["<template>\n  <view class=\"my-container\">\n    <!-- 用户信息卡片 -->\n    <view class=\"user-card\" @click=\"toEditProfile\">\n      <image class=\"avatar\" :src=\"userInfo.avatar || '/static/default-avatar.png'\" />\n      <view class=\"user-info\">\n        <text class=\"username\">\r\n          {{ userInfo?.nickname || (isLoading ? '加载中...' : '未设置昵称') }}\r\n        </text>\n        <text class=\"edit-tip\">点击修改资料</text>\n      </view>\n      <uni-icons type=\"arrowright\" size=\"18\" color=\"#999\" />\n    </view>\n\n    <!-- 功能列表 -->\n    <view class=\"menu-list\">\n      <view class=\"menu-item\" @click=\"handleNavigate('/pages/my/my_messages')\">\n        <view class=\"item-content\">\n          <uni-icons type=\"heart-filled\" size=\"20\" color=\"#ff5a5f\" />\n          <text>我的消息</text>\r\n\t\t    <!-- 新增未读标识 -->\r\n\t\t    <view v-if=\"unreadCount > 0\" class=\"unread-badge\">\r\n\t\t    {{ unreadCount > 99 ? '99+' : unreadCount }}\r\n\t\t\t</view>\n        </view>\n        <uni-icons type=\"arrowright\" size=\"16\" color=\"#999\" />\n      </view>\n\n      <view class=\"menu-item\" @click=\"handleNavigate('/pages/my/my_review')\">\n        <view class=\"item-content\">\n          <uni-icons type=\"chatboxes-filled\" size=\"20\" color=\"#007aff\" />\n          <text>我的评论</text>\n        </view>\n        <uni-icons type=\"arrowright\" size=\"16\" color=\"#999\" />\n      </view>\n\n      <view class=\"menu-item\" @click=\"handleNavigate('/pages/my/my_trips')\">\n        <view class=\"item-content\">\n          <uni-icons type=\"calendar-filled\" size=\"20\" color=\"#4cd964\" />\n          <text>我的行程</text>\n        </view>\n        <uni-icons type=\"arrowright\" size=\"16\" color=\"#999\" />\n      </view>\n\r\n\t<!-- 在.menu-list中添加 -->\r\n\t<view class=\"menu-item\" @click=\"handleNavigate('/pages/my/my_services')\">\r\n\t  <view class=\"item-content\">\r\n\t    <uni-icons type=\"star-filled\" size=\"20\" color=\"#8A2BE2\" />\r\n\t    <text>我的服务</text>\r\n\t  </view>\r\n\t  <uni-icons type=\"arrowright\" size=\"16\" color=\"#999\" />\r\n\t</view>\r\n\t\n      <view class=\"menu-item\" @click=\"handleNavigate('/pages/my/setting')\">\n        <view class=\"item-content\">\n          <uni-icons type=\"gear-filled\" size=\"20\" color=\"#808080\" />\n          <text>设置</text>\n        </view>\n        <uni-icons type=\"arrowright\" size=\"16\" color=\"#999\" />\n      </view>\n    </view>\n\n    <!-- 退出登录按钮 -->\n    <view class=\"logout-btn\">\n      <button @click=\"logout\">退出登录</button>\n    </view>\n  </view>\n</template>\n\n<script>\nimport { mapState, mapMutations } from 'vuex';\r\nimport { http } from '@/api/http';\nexport default {\n\tdata() {\n\t\treturn {\n\t\t\tisLoading: false,\r\n\t\t    unreadCount: 0,\r\n\t\t    pollInterval: null\n\t\t};\n\t},\n\tcomputed: {\r\n\t\t...mapState(\"user\", [\"info\"]),\r\n\t\tuserInfo() {\r\n\t\t\treturn this.info || {}; \r\n\t\t}\r\n\t},\n  onLoad() {\r\n    this.getUserInfo();\r\n  },\r\n\tonShow() {\r\n\t  this.getUserInfo(); \r\n\t  this.fetchUnreadCount();\r\n\t  this.startPolling();\r\n\t},\r\n\tonHide() {\r\n\t  clearInterval(this.pollInterval);\r\n\t},\r\n\t\r\n\tonUnload() {\r\n\t  clearInterval(this.pollInterval);\r\n\t},\n\tmethods: {\n\t\t...mapMutations(\"user\", [\"SET_INFO\", \"CLEAR_ALL\"]),\n\t\tcheckTokenExpiration() {\r\n\t\t\tconst token = uni.getStorageSync(\"token\");\r\n\t\t\tconst expireTime = uni.getStorageSync(\"tokenExpire\");\r\n\t\t\tconsole.debug('Token验证:', { \r\n\t\t\t    tokenExists: !!token,\r\n\t\t\t    expireTime: new Date(expireTime * 1000).toLocaleString(),\r\n\t\t\t    currentTime: new Date().toLocaleString() \r\n\t\t\t});\r\n\t\t\t// 假设 expireTime 存储的是秒，转换为毫秒\r\n\t\t\tif (!token || Date.now() > expireTime) { \r\n\t\t\t    this.CLEAR_ALL();\r\n\t\t\t    return false;\r\n\t\t\t}\r\n\t\t\treturn true;\r\n\t\t},\r\n\t\t// 获取未读消息数量\r\n\t\tasync fetchUnreadCount() {\r\n\t\t  try {\r\n\t\t    const res = await http.get('/api/chat/unread-count');\r\n\t\t    console.log('未读消息响应:', res);\r\n\t\t    \r\n\t\t    if (res.code === 200 && typeof res.data === 'number') {\r\n\t\t      this.unreadCount = res.data;\r\n\t\t    } else {\r\n\t\t      this.unreadCount = 0;\r\n\t\t    }\r\n\t\t  } catch (error) {\r\n\t\t    console.error('获取未读消息失败:', error);\r\n\t\t    this.unreadCount = 0;\r\n\t\t  }\r\n\t\t},\r\n\t\t\r\n\t\t  // 启动轮询\r\n\t\t  startPolling() {\r\n\t\t    this.pollInterval = setInterval(() => {\r\n\t\t      this.fetchUnreadCount();\r\n\t\t    }, 5000);\r\n\t\t\tconsole.log('开始轮询未读消息...');\r\n\t\t  },\n\t\t// 获取用户信息\n\t\t// 修改后的getUserInfo方法\r\n\t\tasync getUserInfo() {\r\n\t\t  this.isLoading = true;\r\n\t\t  try {\r\n\t\t    const res = await http.get(\"/api/user/info\");\r\n\t\t    if (res.code === 200) {\r\n\t\t      const userData = {\r\n\t\t        nickname: res.data.nickname,\r\n\t\t        avatar: res.data.avatar, // 使用后端返回的完整URL\r\n\t\t        gender: res.data.gender,\r\n\t\t        bio: res.data.bio\r\n\t\t      };\r\n\t\t      this.SET_INFO(userData);\r\n\t\t    }\r\n\t\t  } catch (err) {\r\n\t\t    console.error('用户信息获取失败:', err);\r\n\t\t  } finally {\r\n\t\t    this.isLoading = false;\r\n\t\t  }\r\n\t\t},\n\n    // 处理导航跳转\n    handleNavigate(url) {\r\n      const checkToken = this.checkTokenExpiration();\r\n      if (!checkToken) {\r\n              uni.showModal({ // 使用 uni.showModal\r\n                title: \"提示\",\r\n                content: \"请先登录\",\r\n                success: (res) => {\r\n                  if (res.confirm) {\r\n                    uni.navigateTo({ url: \"/pages/login/login\" });\r\n                  }\r\n                }\r\n              });\r\n              return;\r\n            }\r\n      // 仅在用户信息为空时重新获取\r\n      if (!this.userInfo || Object.keys(this.userInfo).length === 0) {\r\n        this.getUserInfo();\r\n      }\r\n      // 统一路径处理\r\n      const targetPath = url.replace(\"/pages/\", \"\").replace(/\\.html$/, \"\");\r\n      const currentPath = getCurrentPages().pop().route;\r\n      if (currentPath !== targetPath) {\r\n        uni.navigateTo({ url });\r\n      }\r\n    },\n\n    // 跳转编辑资料\n    toEditProfile() {\n      this.handleNavigate('/pages/my/edit_profile');\n    },\n\n    // 退出登录\n    logout() {\r\n      uni.showModal({\r\n        title: '提示',\r\n        content: '确定要退出登录吗？',\r\n        success: (res) => {\r\n          if (res.confirm) {\r\n            // 清除用户信息和token\r\n            uni.removeStorageSync('token')\r\n            uni.removeStorageSync('userInfo')\r\n            \r\n            // 跳转到登录页面\r\n            uni.redirectTo({\r\n              url: '/pages/login/login'\r\n            })\r\n          }\r\n        }\r\n      })\r\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.my-container {\n  padding: 20rpx;\n  min-height: 100vh;\n  background-color: #f5f5f5;\n\n  .user-card {\n    display: flex;\n    align-items: center;\n    padding: 30rpx;\n    background-color: #fff;\n    border-radius: 16rpx;\n    margin-bottom: 20rpx;\n    \n    .avatar {\n      width: 120rpx;\n      height: 120rpx;\n      border-radius: 50%;\n      margin-right: 20rpx;\n    }\n\n    .user-info {\n      flex: 1;\n      display: flex;\n      flex-direction: column;\n\n      .username {\n        font-size: 36rpx;\n        font-weight: bold;\n        margin-bottom: 10rpx;\n      }\n\n      .edit-tip {\n        font-size: 24rpx;\n        color: #999;\n      }\n    }\n  }\n\n  .menu-list {\n    background-color: #fff;\n    border-radius: 16rpx;\n    overflow: hidden;\n\n    .menu-item {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 30rpx;\n      border-bottom: 1rpx solid #f0f0f0;\n      \n      &:last-child {\n        border-bottom: none;\n      }\n\n      .item-content {\n        display: flex;\n        align-items: center;\n        \n        text {\n          margin-left: 20rpx;\n          font-size: 32rpx;\n        }\n      }\n    }\n  }\n\n  .logout-btn {\n    margin-top: 40rpx;\n    \n    button {\n      background-color: #fff;\n      color: #2867CE;\n      border: none;\n      height: 90rpx;\n      line-height: 90rpx;\n      font-size: 32rpx;\n      border-radius: 10rpx;\n    }\n  }\n}\r\n  .unread-badge {\r\n    background: #ff5a5f;\r\n    color: white;\r\n    min-width: 36rpx;\r\n    height: 36rpx;\r\n    line-height: 36rpx;\r\n    border-radius: 18rpx;\r\n    font-size: 24rpx;\r\n    text-align: center;\r\n    padding: 0 8rpx;\r\n    margin-left: 16rpx;\r\n  }\n</style>","import MiniProgramPage from 'C:/Users/SZQ/Desktop/jinleyou_uniapp/pages/my/my.vue'\nwx.createPage(MiniProgramPage)"],"names":["mapState","mapMutations","uni","http"],"mappings":"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"}