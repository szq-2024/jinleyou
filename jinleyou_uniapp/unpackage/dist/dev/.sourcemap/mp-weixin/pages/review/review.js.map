{"version":3,"file":"review.js","sources":["pages/review/review.vue","../Programming/HBuilderX.4.57.2025032507/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcmV2aWV3L3Jldmlldy52dWU"],"sourcesContent":["<template>\n  <view class=\"review-container\">\n    <scroll-view scroll-y class=\"form-content\">\n      <!-- 评论内容 -->\n      <view class=\"input-box\">\n        <textarea\n          v-model=\"content\"\n          placeholder=\"写下你的游玩体验...\"\n          maxlength=\"500\"\n          auto-height\n          class=\"comment-input\"\n        />\n        <text class=\"word-count\">{{ content.length }}/500</text>\n      </view>\n\n      <!-- 图片上传 -->\n      <view class=\"upload-section\">\n        <text class=\"section-title\">添加图片（最多9张）</text>\n        <view class=\"image-list\">\n          <view \n            v-for=\"(img, index) in imageList\"\n            :key=\"img.url\"\n            class=\"image-item\"\n          >\n            <image \n              :src=\"img.url\" \n              class=\"preview-image\"\n              mode=\"aspectFill\"\n              @click=\"previewImage(index)\"\n              @error=\"handleImageError(index)\"  \n            />\n            <uni-icons \n              type=\"close\" \n              size=\"20\" \n              color=\"#fff\" \n              class=\"delete-icon\"\n              @click=\"deleteImage(index)\"\n            />\n            <view v-if=\"img.uploading\" class=\"upload-mask\">\n              <progress \n                :percent=\"img.progress\" \n                stroke-width=\"4\"\n                class=\"progress\"\n              />\n            </view>\n          </view>\n          \n          <view \n            v-if=\"imageList.length < 9\"\n            class=\"upload-btn\"\n            @click=\"chooseImage\"\n          >\n            <uni-icons type=\"plusempty\" size=\"40\" color=\"#ccc\" />\n          </view>\n        </view>\n      </view>\n\n      <!-- 提交按钮 -->\n      <button \n        class=\"submit-btn\"\n        :class=\"{ disabled: !canSubmit || submitting }\"\n        :disabled=\"!canSubmit || submitting\"\n        @click=\"submitReview\"\n      >\n        <text v-if=\"!submitting\">提交评论</text>\n        <uni-load-more v-else status=\"loading\" :icon-size=\"16\" />\n      </button>\n    </scroll-view>\n  </view>\n</template>\n\n<script>\nimport { http, ENV_CONFIG } from '@/api/http';\n\nexport default {\n  data() {\n    return {\n      scenicId: null,\n      content: '',\n      imageList: [], // {url: string, uploading: bool, progress: number}\n      submitting: false\n    };\n  },\n  computed: {\n    canSubmit() {\n      return this.content.trim().length >= 5 && \n        !this.imageList.some(img => img.uploading)\n    }\n  },\n  onLoad(options) {\n    this.scenicId = options.id;\n  },\n  methods: {\n    // 选择图片\n    async chooseImage() {\n      const remain = 9 - this.imageList.length;\n      if (remain <= 0) return;\n      \n      try {\n        const res = await uni.chooseImage({\n          count: remain,\n          sizeType: ['compressed'],\n          sourceType: ['album', 'camera']\n        });\n\n        res.tempFilePaths.forEach(path => {\n          this.imageList.push({\n            url: path,\n            uploading: true,\n            progress: 0\n          });\n          this.uploadImage(path, this.imageList.length - 1);\n        });\n      } catch (error) {\n        uni.showToast({ title: '选择图片失败', icon: 'none' });\n      }\n    },\n\n    // 上传单张图片\n    async uploadImage(filePath, index) {\n      try {\n        const uploadRes = await new Promise((resolve, reject) => {\n          const uploadTask = uni.uploadFile({\n            url: `${ENV_CONFIG[process.env.NODE_ENV]}/api/scenic-spots/upload`,\n            filePath,\n            name: 'file',\n            header: {\n              Authorization: `Bearer ${uni.getStorageSync('token')}`\n            },\n            success: (res) => resolve(res),\n            fail: (err) => reject(err)\n          });\n\n          uploadTask.onProgressUpdate = (res) => {\n            this.imageList[index].progress = res.progress;\n            if (res.progress === 100) {\n              setTimeout(() => {\n                this.imageList[index].uploading = false;\n              }, 300);\n            }\n          };\n        });\n\n        if (uploadRes.statusCode !== 200) {\n          throw new Error(`上传失败，状态码：${uploadRes.statusCode}`);\n        }\n\n        const data = JSON.parse(uploadRes.data);\n        if (data.code !== 200) {\n          throw new Error(data.msg || '上传失败');\n        }\n\n        const fullUrl = data.data.url.startsWith('http') \n          ? data.data.url \n          : `${ENV_CONFIG[process.env.NODE_ENV]}${data.data.url}`;\n        \n        this.imageList[index].url = fullUrl;\n        this.imageList[index].uploading = false;\n\n      } catch (error) {\n        this.imageList.splice(index, 1);\n        uni.showToast({ \n          title: `上传失败: ${error.message}`,\n          icon: 'none',\n          duration: 3000\n        });\n      }\n    },\n\n    // 删除图片\n    deleteImage(index) {\n      uni.showModal({\n        title: '提示',\n        content: '确定删除这张图片吗？',\n        success: (res) => {\n          if (res.confirm) {\n            this.imageList.splice(index, 1);\n          }\n        }\n      });\n    },\n\n    // 图片加载失败处理\n    handleImageError(index) {\n      this.imageList.splice(index, 1);\n      uni.showToast({ \n        title: '图片加载失败，已移除',\n        icon: 'none'\n      });\n    },\n\n    // 预览图片\n    previewImage(index) {\n      uni.previewImage({\n        current: index,\n        urls: this.imageList.map(img => img.url)\n      });\n    },\n\n    // 提交评论\n    async submitReview() {\n      if (!this.canSubmit || this.submitting) return;\n      \n      this.submitting = true;\n      \n      if (!this.scenicId) {\n        uni.showToast({ title: '参数错误，无法提交评论', icon: 'none' });\n        return;\n      }\n\n      try {\n        const images = this.imageList.map(img => img.url);\n        \n        const { code, msg } = await http.post(\n          `/api/scenic-spots/${this.scenicId}/reviews`, \n          {\n            content: this.content.trim(),\n            images\n          }\n        );\n\n        if (code === 200) {\r\n          uni.showToast({ title: '评论提交成功' });\r\n          // 修改事件名称与详情页监听一致\r\n          uni.$emit('review-submitted'); \r\n          setTimeout(() => uni.navigateBack(), 1500);\r\n        } else {\n          uni.showToast({ title: msg || '提交失败', icon: 'none' });\n        }\n      } catch (error) {\n        console.error('提交失败:', error);\n        uni.showToast({ title: '提交失败，请重试', icon: 'none' });\n      } finally {\n        this.submitting = false;\n      }\n    }\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n.review-container {\n  height: 100vh;\n  background-color: #f5f5f5;\n  box-sizing: border-box;\n  \n  .form-content {\n    padding: 30rpx;\n    height: calc(100vh - var(--window-top));\n    box-sizing: border-box;\n    \n    .input-box {\n      background: #fff;\n      padding: 30rpx;\n      border-radius: 12rpx;\n      margin-bottom: 30rpx;\n      \n      .comment-input {\n        width: 100%;\n        min-height: 200rpx;\n        font-size: 28rpx;\n        box-sizing: border-box;\n      }\n      \n      .word-count {\n        color: #999;\n        font-size: 24rpx;\n        text-align: right;\n        display: block;\n        margin-top: 20rpx;\n      }\n    }\n    \n    .upload-section {\n      background: #fff;\n      padding: 30rpx;\n      border-radius: 12rpx;\n      margin-bottom: 30rpx;\n      \n      .section-title {\n        font-size: 28rpx;\n        color: #666;\n        margin-bottom: 20rpx;\n        display: block;\n      }\n      \n      .image-list {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 20rpx;\n        \n        .image-item, .upload-btn {\n          width: calc((100% - 40rpx) / 3); /* 三列布局 */\n          aspect-ratio: 1; /* 保持正方形 */\n          border-radius: 8rpx;\n          position: relative;\n          overflow: hidden;\n          background: #f8f8f8;\n        }\n        \n        .image-item {\n          .preview-image {\n            width: 100%;\n            height: 100%;\n          }\n          \n          .delete-icon {\n            position: absolute;\n            right: 8rpx;\n            top: 8rpx;\n            background: rgba(0,0,0,0.5);\n            border-radius: 50%;\n            padding: 4rpx;\n          }\n          \n          .upload-mask {\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0,0,0,0.4);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            \n            .progress {\n              width: 80%;\n            }\n          }\n        }\n        \n        .upload-btn {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border: 2rpx dashed #ccc;\n        }\n      }\n    }\n    \n    .submit-btn {\n      width: 100%;\n      background: #2867CE;\n      color: #fff;\n      height: 88rpx;\n      line-height: 88rpx;\n      border-radius: 44rpx;\n      font-size: 32rpx;\n      margin-top: 30rpx;\n      \n      &.disabled {\n        background: #ccc;\n        opacity: 0.7;\n      }\n    }\n  }\n}\n</style>","import MiniProgramPage from 'C:/Users/SZQ/Desktop/jinleyou_uniapp/pages/review/review.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","ENV_CONFIG","http"],"mappings":"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"}