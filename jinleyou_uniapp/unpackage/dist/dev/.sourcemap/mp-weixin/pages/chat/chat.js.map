{"version":3,"file":"chat.js","sources":["pages/chat/chat.vue","../Programming/HBuilderX.4.57.2025032507/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hhdC9jaGF0LnZ1ZQ"],"sourcesContent":["<!-- pages/chat/chat.vue -->\n<template>\n  <view class=\"container\">\n    <!-- 聊天内容区域 -->\n    <scroll-view \n      class=\"chat-scroll\"\n      scroll-y \n      :scroll-top=\"scrollTop\"\n      :scroll-with-animation=\"true\"\n      @scroll=\"handleScroll\"\n    >\n      <view \n        v-for=\"(msg, index) in messages\" \n        :key=\"msg.id\"\n        class=\"message-wrap\"\n        :class=\"{ 'self-message': msg.senderId === currentUserId }\"\n      >\n        <!-- 对方头像 -->\n        <image \n          v-if=\"msg.senderId !== currentUserId\"\n          :src=\"msg.senderAvatar || '/static/default-avatar.png'\"\n          class=\"avatar\"\n        />\n        \n        <!-- 消息容器 -->\n        <view class=\"bubble-container\">\n          <view class=\"bubble\" :class=\"{ 'self-bubble': msg.senderId === currentUserId }\">\n            <text class=\"content\">{{ msg.content }}</text>\n          </view>\n          <text class=\"time\">{{ formatTime(msg.createdAt) }}</text>\n        </view>\n      </view>\n      <view id=\"bottom-anchor\"></view>\n    </scroll-view>\n\n    <!-- 输入区域 -->\n    <view class=\"input-area\">\n      <input\n        v-model=\"inputValue\"\n        class=\"input\"\n        placeholder=\"输入消息\"\n        :adjust-position=\"false\"\n        @confirm=\"sendMessage\"\n      />\n      <button class=\"send-btn\" @click=\"sendMessage\">发送</button>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, onMounted, nextTick } from 'vue'\nimport { onLoad } from '@dcloudio/uni-app'\nimport dayjs from 'dayjs'\nimport { http } from '@/api/http'\n\nconst currentUserId = ref(Number(uni.getStorageSync('userId')));\nconst currentUserAvatar = ref('')\nconst targetUserId = ref(null)\nconst messages = ref([])\nconst inputValue = ref('')\nconst scrollTop = ref(0)\nconst autoScroll = ref(true)\nconst systemInfo = ref({})\n\nconst formatTime = (time) => {\n  return dayjs(time).format('HH:mm')\n}\n\nconst handleScroll = (e) => {\n  // 当用户手动向上滚动时，暂停自动滚动\n  const { scrollHeight, scrollTop: st, deltaY } = e.detail\n  autoScroll.value = st + deltaY >= scrollHeight - 500\n}\n\nconst scrollToBottom = async (animate = true) => {\n  if (!autoScroll.value) return\n  \n  await nextTick()\n  const query = uni.createSelectorQuery()\n  query.select('#bottom-anchor').boundingClientRect()\n  query.select('.chat-scroll').boundingClientRect()\n  query.exec(res => {\n    if (res[0] && res[1]) {\n      scrollTop.value = res[0].top - res[1].top + scrollTop.value\n      // 添加防抖处理\n      setTimeout(() => autoScroll.value = true, 500)\n    }\n  })\n}\n\nconst loadMessages = async () => {\n  try {\n    const res = await http.get(`/api/chat/${targetUserId.value}`)\n    messages.value = res.data.map(msg => ({\n      ...msg,\n      createdAt: msg.createdAt,\n      senderAvatar: msg.senderAvatar || '/static/default-avatar.png'\n    }))\n    await scrollToBottom(false)\n  } catch (e) {\n    uni.showToast({ title: '加载消息失败', icon: 'none' })\n  }\n}\n\nconst sendMessage = async () => {\n  if (!inputValue.value.trim()) return\n  \n  try {\n    const res = await http.post('/api/chat', {\n      receiverId: targetUserId.value,\n      content: inputValue.value\n    })\n    \n    messages.value.push({\n      id: res.id,\n      senderId: currentUserId.value,\n      content: inputValue.value,\n      createdAt: new Date().toISOString(),\n      senderAvatar: currentUserAvatar.value\n    })\n    \n    inputValue.value = ''\n    await scrollToBottom()\n  } catch (e) {\n    uni.showToast({ title: '发送失败', icon: 'none' })\n  }\n}\n\nconst markAsRead = async () => {\n  try {\n    await http.put(`/api/chat/${targetUserId.value}/mark-as-read`)\n  } catch (e) {\n    console.error('标记已读失败', e)\n  }\n}\n\nonLoad(async (options) => {\n  targetUserId.value = options.userId\n  systemInfo.value = await uni.getSystemInfoSync()\n  await loadMessages()\n  markAsRead()\n})\n\n// 处理键盘高度变化\nlet keyboardHeight = 0\nuni.onKeyboardHeightChange(res => {\n  keyboardHeight = res.height\n  const scrollHeight = systemInfo.value.windowHeight - (keyboardHeight ? 190 : 120)\n  scrollTop.value += keyboardHeight ? -50 : 50\n})\n</script>\n\n<style lang=\"scss\">\n.container {\n  height: 100vh;\n  display: flex;\n  flex-direction: column;\n  background: #f5f5f5;\n  position: relative;\n}\n\n.chat-scroll {\n  height: calc(100vh - 120rpx); // 动态高度\n  padding: 20rpx 20rpx 0;\n  box-sizing: border-box;\n  overflow-anchor: auto; // 启用自动锚定\n}\n\n.input-area {\n  height: 100rpx;\n  background: #fff;\n  border-top: 1rpx solid #eee;\n  padding: 20rpx;\n  display: flex;\n  align-items: center;\n  position: relative;\n  z-index: 999;\n}\n\n.message-wrap {\n  display: flex;\n  margin-bottom: 40rpx;\n  align-items: flex-start;\n  \n  &.self-message {\n    flex-direction: row-reverse;\n    .bubble-container {\n      align-items: flex-end;\n    }\n  }\n}\n\n.avatar {\n  width: 80rpx;\n  height: 80rpx;\n  border-radius: 8rpx;\n  margin: 0 20rpx;\n}\n\n.bubble-container {\n  display: flex;\n  flex-direction: column;\n  max-width: 70%;\n  min-height: 80rpx;\n}\n\n.bubble {\n  padding: 20rpx;\n  border-radius: 12rpx;\n  background: #fff;\n  position: relative;\n  word-break: break-word;\n  \n  .content {\n    font-size: 28rpx;\n    line-height: 1.5;\n    color: #333;\n  }\n\n  &.self-bubble {\n    background: #007AFF;\n    .content {\n      color: white;\n    }\n  }\n}\n\n.time {\n  font-size: 20rpx;\n  color: #999;\n  margin-top: 10rpx;\n}\n\n.input {\n  flex: 1;\n  height: 70rpx;\n  padding: 0 20rpx;\n  border: 1rpx solid #ddd;\n  border-radius: 8rpx;\n  margin-right: 20rpx;\n  font-size: 28rpx;\n}\n\n.send-btn {\n  width: 140rpx;\n  height: 70rpx;\n  line-height: 70rpx;\n  background: #007AFF;\n  color: white;\n  border-radius: 8rpx;\n  font-size: 28rpx;\n  transition: opacity 0.2s;\n  \n  &:active {\n    opacity: 0.8;\n  }\n}\n</style>","import MiniProgramPage from 'C:/Users/SZQ/Desktop/jinleyou_uniapp/pages/chat/chat.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","dayjs","nextTick","http","onLoad","MiniProgramPage"],"mappings":"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"}